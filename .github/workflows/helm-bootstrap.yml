name: Bootstrap Helm Chart
on:
  workflow_call:
    inputs:
      NAMESPACE:
        type: string
        description: Namespace
        required: true   
    secrets:
      CLUSTER_CONFIG:
        required: true
      BASE64DOCKERAUTH:
        required: true
jobs:
  deploy:
    runs-on: ubuntu-latest
    container:
      image: alpine/helm:3.16.2
      env:
        CLUSTER_CONFIG: ${{ secrets.CLUSTER_CONFIG }}
        BASE64DOCKERAUTH: ${{ secrets.BASE64DOCKERAUTH }}
        NAMESPACE: ${{ inputs.NAMESPACE }}
    steps:
      - uses: actions/checkout@v4
      - name: Install kubectl
        run: |
          apk add --no-cache curl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /usr/local/bin/
      - name: Bootstrap helm release
        run: |
          echo ${CLUSTER_CONFIG} | base64 -d > /kubeconfig.yml

          # Replace #NAMESPACE# in all yml files in bootstrap folder
          for file in bootstrap/*.yml; do
            if [ -f "$file" ]; then
              sed -i -e "s|#NAMESPACE#|$NAMESPACE|g" "$file"
            fi
          done

          # Replace #BASE64DOCKERAUTH# in imagepull.yml if it exists
          if [ -f bootstrap/imagepull.yml ]; then
            sed -i -e "s|#BASE64DOCKERAUTH#|$BASE64DOCKERAUTH|g" \
              bootstrap/imagepull.yml
          fi

          # Apply namespace.yml first if it exists
          if [ -f bootstrap/namespace.yml ]; then
            kubectl apply -f bootstrap/namespace.yml \
              --kubeconfig=/kubeconfig.yml
          fi

          # Apply all other yml files in the bootstrap folder
          for file in bootstrap/*.yml; do
            if [ -f "$file" ] && [ "$file" != "bootstrap/namespace.yml" ]; then
              kubectl apply -f "$file" --namespace ${NAMESPACE} \
                --kubeconfig=/kubeconfig.yml
            fi
          done
